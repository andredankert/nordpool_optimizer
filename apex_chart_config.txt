type: custom:apexcharts-card
header:
  title: Nordpool Prices & Device Periods
  show: true
series:
  - entity: sensor.nordpool_price_graph
    data_generator: |
      const prices = entity.attributes.prices_ahead || [];

      const priceMap = new Map();
      prices.forEach(item => {
        const timeKey = item.time;
        if (!priceMap.has(timeKey)) {
          priceMap.set(timeKey, item);
        }
      });

      const uniquePrices = Array.from(priceMap.values())
        .map(item => {
          const time = new Date(item.time).getTime();
          const price = parseFloat(item.price);
          return [time, price];
        })
        .filter(item => !isNaN(item[0]) && !isNaN(item[1]) && isFinite(item[1]))
        .sort((a, b) => a[0] - b[0]);

      // Compute 2-day display window based on actual data availability
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const tomorrowStart = todayStart + 86400000;
      const hasTomorrow = uniquePrices.some(p => p[0] >= tomorrowStart);
      window.__npMin = hasTomorrow ? todayStart : todayStart - 86400000;
      window.__npMax = window.__npMin + 172800000;

      return uniquePrices;
    name: Price (kr/kWh)
    type: line
    color: "#2196F3"
  - entity: sensor.nordpool_price_graph
    data_generator: |
      // Show AC device specifically
      const periods = entity.attributes.device_periods || [];
      const acDevice = periods.find(d => d.device === '7h');

      if (!acDevice || acDevice.periods.length === 0) return [];

      const result = [];
      acDevice.periods.forEach(period => {
        const startTime = new Date(period.start).getTime();
        const endTime = new Date(period.end).getTime();
        result.push([startTime, acDevice.y_position]);
        result.push([endTime, acDevice.y_position]);
        result.push([null, null]);
      });

      return result;
    name: 7H
    type: line
    color: "#2196F3"
    opacity: 0.8
  - entity: sensor.nordpool_price_graph
    data_generator: |
      // Show AC device specifically
      const periods = entity.attributes.device_periods || [];
      const f6hDevice = periods.find(d => d.device === '3h');

      if (!f6hDevice || f6hDevice.periods.length === 0) return [];

      const result = [];
      f6hDevice.periods.forEach(period => {
        const startTime = new Date(period.start).getTime();
        const endTime = new Date(period.end).getTime();
        result.push([startTime, f6hDevice.y_position]);
        result.push([endTime, f6hDevice.y_position]);
        result.push([null, null]);
      });

      return result;
    name: 3H
    type: line
    color: "#F116F3"
    opacity: 0.8
  - entity: sensor.nordpool_price_graph
    data_generator: >
      // Show Dehumidifier device specifically

      const periods = entity.attributes.device_periods || [];

      const dehumidifierDevice = periods.find(d => d.device === 'Dehumidifier');


      if (!dehumidifierDevice || dehumidifierDevice.periods.length === 0) return
      [];


      const result = [];

      dehumidifierDevice.periods.forEach(period => {
        const startTime = new Date(period.start).getTime();
        const endTime = new Date(period.end).getTime();
        result.push([startTime, dehumidifierDevice.y_position]);
        result.push([endTime, dehumidifierDevice.y_position]);
        result.push([null, null]);
      });


      return result;
    name: Dehumidifier
    type: line
    color: "#4CAF50"
    opacity: 0.8
  - entity: sensor.nordpool_price_graph
    data_generator: >
      // Create "Now" marker as a vertical line through the price range

      const currentTime = entity.attributes.current_time;

      const now = currentTime ? new Date(currentTime).getTime() : new
      Date().getTime();


      const prices = entity.attributes.prices_ahead || [];

      if (prices.length === 0) return [];


      const priceValues = prices.map(p => parseFloat(p.price)).filter(p =>
      !isNaN(p));

      const minPrice = Math.min(...priceValues);

      const maxPrice = Math.max(...priceValues);


      return [
        [now, minPrice],
        [now, maxPrice],
        [null, null]
      ];
    name: Now
    type: line
    color: "#FF0000"
span:
  start: day
  offset: "-1d"
graph_span: 3d
apex_config:
  chart:
    height: 350
    events:
      mounted: |
        EVAL:function(chartContext, config) {
          if (window.__npMin && window.__npMax) {
            chartContext.zoomX(window.__npMin, window.__npMax);
          }
        }
      updated: |
        EVAL:function(chartContext, config) {
          if (window.__npMin && window.__npMax) {
            chartContext.zoomX(window.__npMin, window.__npMax);
          }
        }
  stroke:
    width: 3
  legend:
    showForSingleSeries: true
    formatter: |
      EVAL:function(seriesName, opts) {
        return seriesName;
      }
  xaxis:
    type: datetime
  yaxis:
    title:
      text: Price (kr/kWh)
